# .github/workflows/update-qr-ticket.yml
name: –û–±–Ω–æ–≤–∏—Ç—å QR-–∫–æ–¥ –∏ –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞

on:
  # üïí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –¥–≤–∞ —Ä–∞–∑–∞ –≤ –¥–µ–Ω—å (–ø–æ –ì–µ—Ä–º–∞–Ω–∏–∏: 5:00 –∏ 17:00)
  schedule:
    - cron: '0 3,15 * * *'   # –õ–µ—Ç–æ–º: 5:00 –∏ 17:00 CEST = 3:00 –∏ 15:00 UTC
    - cron: '0 4,16 * * *'   # –ó–∏–º–æ–π: 5:00 –∏ 17:00 CET = 4:00 –∏ 16:00 UTC

  # üñ±Ô∏è –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub
  workflow_dispatch:

jobs:
  update-ticket-
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: üêç –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–∞
      - name: üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞
        run: python update_ticket.py

      # 5. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ ticket_data.json (–Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏)
      - name: üõ°Ô∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ ticket_data.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        run: |
          if [ ! -f "ticket_data.json" ]; then
            echo "‚ö†Ô∏è –§–∞–π–ª ticket_data.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π."
            python -c "
import json
from datetime import datetime
data = {
    'ticket_number': 'REZERV-000000',
    'valid_from': '01.11.2025 - 00:00',
    'valid_until': '01.12.2025 - 03:00',
    'region': 'Deutschlandweit',
    'class': '2. Klasse',
    'price_level': 'deutschlandweit',
    'last_updated': datetime.now().strftime('%d.%m.%Y %H:%M:%S')
}
with open('ticket_data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
            "
          fi

      # 6. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω–∞–ª–∏—á–∏–µ QR-–∫–æ–¥–∞
      - name: üñºÔ∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ qr-code.png —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        run: |
          if [ ! -f "qr-code.png" ]; then
            echo "‚ö†Ô∏è QR-–∫–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. –°–æ–∑–¥–∞—ë–º placeholder."
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42IAAAAASUVORK5CYII=" | base64 -d > qr-code.png
          fi

      # 7. –û–±–Ω–æ–≤–ª—è–µ–º index.html –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ JSON
      - name: üìÑ –û–±–Ω–æ–≤–∏—Ç—å HTML-—Ñ–∞–π–ª
        run: |
          python -c "
import json
from bs4 import BeautifulSoup

with open('ticket_data.json', 'r', encoding='utf-8') as f:
    ticket = json.load(f)

with open('index.html', 'r', encoding='utf-8') as f:
    soup = BeautifulSoup(f, 'html.parser')

fields = {
    'ticketNumber': ticket['ticket_number'],
    'validFrom': ticket['valid_from'],
    'validUntil': ticket['valid_until'],
    'region': ticket['region'],
    'class': ticket['class'],
    'priceLevel': ticket.get('price_level', 'deutschlandweit'),
    'lastUpdatedTime': ticket['last_updated']
}

for elem_id, value in fields.items():
    el = soup.find(id=elem_id)
    if el:
        el.string = str(value)

with open('index.html', 'w', encoding='utf-8') as f:
    f.write(str(soup))

print('‚úÖ index.html –æ–±–Ω–æ–≤–ª—ë–Ω.')
          "

      # 8. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git
      - name: üíæ –ó–∞–∫–æ–º–º–∏—Ç–∏—Ç—å –∏ –∑–∞–ø—É—à–∏—Ç—å
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞ ‚Äî $(date '+%d.%m.%Y %H:%M')"
          file_pattern: |
            qr-code.png
            ticket_data.json
            index.html

# .github/workflows/update-qr-ticket.yml
name: –û–±–Ω–æ–≤–∏—Ç—å QR-–∫–æ–¥ –∏ –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞

on:
  # üïí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 5:00 –∏ 17:00 –ø–æ –ì–µ—Ä–º–∞–Ω–∏–∏ (CET/CEST)
  schedule:
    - cron: '0 4,16 * * *'   # 5:00 –∏ 17:00 CET –∑–∏–º–æ–π ‚Üí 4:00/16:00 UTC
    - cron: '0 3,15 * * *'   # 5:00 –∏ 17:00 CEST –ª–µ—Ç–æ–º ‚Üí 3:00/15:00 UTC

  # üñ±Ô∏è –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ GitHub UI
  workflow_dispatch:
    inputs:
      reason:
        description: '–ü—Ä–∏—á–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'
        required: false
        default: '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫'

jobs:
  update-ticket-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python
      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      # 4Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      - name: üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞
        run: python update_ticket.py

      # 5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç (—Å–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤, –µ—Å–ª–∏ –Ω–µ—Ç)
      - name: üîç –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ ticket_data.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        run: |
          if [ ! -f "ticket_data.json" ]; then
            echo "‚ö†Ô∏è ticket_data.json –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—ë–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Ñ–∞–π–ª."
            python -c "
import json
from datetime import datetime
data = {
    'ticket_number': 'BACKUP-000000',
    'valid_from': '01.11.2025 - 00:00',
    'valid_until': '01.12.2025 - 03:00',
    'region': 'Deutschlandweit',
    'class': '2. Klasse',
    'price_level': 'deutschlandweit',
    'last_updated': datetime.now().strftime('%d.%m.%Y %H:%M:%S')
}
with open('ticket_data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
            "
          fi

      - name: üñºÔ∏è –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ qr-code.png —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        run: |
          if [ ! -f "qr-code.png" ]; then
            echo "‚ö†Ô∏è qr-code.png –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—ë–º placeholder."
            # –ü—Ä–æ—Å—Ç–æ–π 1x1 –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π PNG –≤ base64 ‚Üí –¥–µ–∫–æ–¥–∏—Ä—É–µ–º
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42IAAAAASUVORK5CYII=" | base64 -d > qr-code.png
          fi

      # 6Ô∏è‚É£ –û–±–Ω–æ–≤–ª—è–µ–º index.html –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ ticket_data.json
      - name: üìÑ –û–±–Ω–æ–≤–∏—Ç—å index.html
        run: |
          python -c "
import json
from bs4 import BeautifulSoup

# –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞
with open('ticket_data.json', 'r', encoding='utf-8') as f:
    ticket = json.load(f)

# –ß–∏—Ç–∞–µ–º HTML
with open('index.html', 'r', encoding='utf-8') as f:
    soup = BeautifulSoup(f, 'html.parser')

# –û–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ ID
mapping = {
    'ticketNumber': ticket['ticket_number'],
    'validFrom': ticket['valid_from'],
    'validUntil': ticket['valid_until'],
    'region': ticket['region'],
    'class': ticket['class'],
    'priceLevel': ticket.get('price_level', 'deutschlandweit'),
    'lastUpdatedTime': ticket['last_updated']
}

for elem_id, value in mapping.items():
    el = soup.find(id=elem_id)
    if el:
        el.string = str(value)

# –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π HTML
with open('index.html', 'w', encoding='utf-8') as f:
    f.write(str(soup))

print('‚úÖ index.html —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω.')
          "

      # 7Ô∏è‚É£ –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Git
      - name: üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞: $(date '+%d.%m.%Y %H:%M CET')"
          file_pattern: |
            qr-code.png
            ticket_data.json
            index.html
          push_options: '--no-verify'
          skip_dirty_check: false
          skip_fetch: true

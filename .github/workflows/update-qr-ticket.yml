# .github/workflows/update-qr-ticket.yml
name: Обновить QR-код и данные билета

on:
  schedule:
    - cron: '0 3,15 * * *'
    - cron: '0 4,16 * * *'
  workflow_dispatch:

jobs:
  update-ticket-
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Клонировать репозиторий
        uses: actions/checkout@v4

      - name: Настроить Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Установить зависимости
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4

      - name: Обновить данные билета
        run: python update_ticket.py

      - name: Убедиться, что ticket_data.json существует
        run: |
          if [ ! -f "ticket_data.json" ]; then
            echo "Файл ticket_data.json не найден. Создаём резервный."
            python -c "
import json
from datetime import datetime
data = {
    'ticket_number': 'REZERV-000000',
    'valid_from': '01.11.2025 - 00:00',
    'valid_until': '01.12.2025 - 03:00',
    'region': 'Deutschlandweit',
    'class': '2. Klasse',
    'price_level': 'deutschlandweit',
    'last_updated': datetime.now().strftime('%d.%m.%Y %H:%M:%S')
}
with open('ticket_data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
            "
          fi

      - name: Убедиться, что qr-code.png существует
        run: |
          if [ ! -f "qr-code.png" ]; then
            echo "QR-код отсутствует. Создаём placeholder."
            echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42IAAAAASUVORK5CYII=" | base64 -d > qr-code.png
          fi

      - name: Обновить HTML-файл
        run: |
          python -c "
import json
from bs4 import BeautifulSoup

with open('ticket_data.json', 'r', encoding='utf-8') as f:
    ticket = json.load(f)

with open('index.html', 'r', encoding='utf-8') as f:
    soup = BeautifulSoup(f, 'html.parser')

fields = {
    'ticketNumber': ticket['ticket_number'],
    'validFrom': ticket['valid_from'],
    'validUntil': ticket['valid_until'],
    'region': ticket['region'],
    'class': ticket['class'],
    'priceLevel': ticket.get('price_level', 'deutschlandweit'),
    'lastUpdatedTime': ticket['last_updated']
}

for elem_id, value in fields.items():
    el = soup.find(id=elem_id)
    if el:
        el.string = str(value)

with open('index.html', 'w', encoding='utf-8') as f:
    f.write(str(soup))

print('index.html обновлён.')
          "

      - name: Закоммитить и запушить
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Автообновление билета — $(date '+%d.%m.%Y %H:%M')"
          file_pattern: |
            qr-code.png
            ticket_data.json
            index.html

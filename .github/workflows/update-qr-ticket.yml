# .github/workflows/update-qr-ticket.yml
name: Обновить QR-код и ID билета

# Запускать по расписанию: в 5:00 и 3:00 UTC каждый день
on:
  schedule:
    - cron: '0 5,3 * * *'
  workflow_dispatch:

jobs:
  update-ticket-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Дать разрешение на запись в репозиторий

    steps:
      # Шаг 1: Клонируем репозиторий
      - name: Клонировать репозиторий
        uses: actions/checkout@v4

      # Шаг 2: Устанавливаем Python и необходимые библиотеки
      - name: Установить Python и зависимости
        run: |
          python -m pip install requests beautifulsoup4

      # Шаг 3: Запускаем Python-скрипт для извлечения данных
      - name: Извлечь данные билета
        run: python update_ticket.py

      # Шаг 4: Читаем номер билета из временного файла и обновляем index.html
      - name: Обновить номер билета в index.html
        run: |
          # Читаем новый номер билета
          NEW_TICKET_NUMBER=$(cat ticket_number.txt)
          echo "Новый номер билета для вставки: $NEW_TICKET_NUMBER"
          
          # Используем sed для замены старого номера на новый
          # Ищем строку <span class="value" id="ticketNumber">...</span> и заменяем ее
          sed -i "s|<span class=\"value\" id=\"ticketNumber\">.*</span>|<span class=\"value\" id=\"ticketNumber\">${NEW_TICKET_NUMBER}</span>|g" index.html
          echo "index.html обновлен."

      # Шаг 5: Сохраняем и отправляем изменения в репозиторий
      - name: Сохранить и запушить изменения
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Автообновление: QR-код и ID билета"
          branch: main # Укажите вашу основную ветку
          file_pattern: 'qr-code.png index.html' # Обновляем оба файла

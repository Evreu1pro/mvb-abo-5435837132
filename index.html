<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVB - Deutschland-Ticket</title>
    <link rel="icon" href="https://www.mvbnet.de//files/2017/01/logo.png" type="image/x-icon">
    <style>
        :root {
            --bg: #e8f0ec;
            --fg: #333;
            --surface: #fff;
            --border: #d0d0d0;
            --subtle: #f0f4f2;
            --accent: #008060;
            --accent-rgb: 0, 128, 96;
            --sh1: rgba(144, 238, 144, .25);
            --sh2: rgba(144, 238, 144, .08);
        }
        
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0a1e16;
                --fg: #e6e6e6;
                --surface: #1e1e1e;
                --border: #333;
                --subtle: #2a2a2a;
                --accent: #00e6a8;
                --accent-rgb: 0, 230, 168;
                --sh1: rgba(0, 230, 168, .08);
                --sh2: rgba(0, 230, 168, .03);
            }
        }
        
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--fg);
            background: linear-gradient(-45deg, var(--bg) 25%, var(--sh1) 35%, var(--bg) 45%, var(--sh2) 55%, var(--bg) 65%);
            background-size: 400% 400%;
            animation: shimmer 18s ease infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }
        
        .ticket-container {
            width: 100%;
            max-width: 400px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .1);
            padding: 24px;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        
        .logo-header-container {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 15px;
            background-color: var(--subtle);
        }
        
        .logo-header {
            width: 160px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        
        .qr-section {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .qr-image {
            width: 220px;
            height: 220px;
            border-radius: 10px;
            margin: 0 auto;
            display: block;
            object-fit: contain;
            background-color: var(--subtle);
            padding: 10px;
            transition: transform 0.2s ease;
        }
        
        .qr-image:hover {
            transform: scale(1.02);
        }
        
        .update-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .update-btn {
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 12px 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .update-btn:hover {
            background: #006c4d;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        
        .update-btn:active {
            transform: translateY(0);
        }
        
        .update-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--fg);
            margin-top: 5px;
            padding: 8px 12px;
            background: var(--subtle);
            border-radius: 12px;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(var(--accent-rgb), 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .ticket-number {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 15px 0;
            color: var(--accent);
        }
        
        .ticket-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px 8px;
            margin: 20px 0;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.75rem;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .detail-value {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .footer {
            font-size: 0.75rem;
            opacity: 0.7;
            text-align: center;
            border-top: 1px dashed var(--border);
            padding-top: 16px;
            margin-top: 15px;
        }
        
        .footer a {
            color: var(--accent);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .liveness-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
            background-size: 200% 100%;
            animation: liveness-scan 3s linear infinite;
        }
        
        @keyframes liveness-scan {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body>
    <div class="ticket-container">
        <div class="logo-header-container">
            <img src="https://www.mvbnet.de//files/2017/01/logo.png" alt="MVB Logo" class="logo-header">
        </div>
        
        <div class="qr-section">
            <img src="qr-code.png" alt="QR-Code" class="qr-image" id="qrImage">
        </div>
        
        <div class="update-container">
            <button class="update-btn" id="updateBtn">
                <svg viewBox="0 0 24 24" width="20" height="20">
                    <path fill="currentColor" d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Ticket aktualisieren
            </button>
            <div class="status-indicator" id="statusIndicator">
                <span>Letzte Aktualisierung: <span id="lastUpdatedTime">Wird geladen...</span></span>
                <span id="statusIcon"></span>
            </div>
        </div>
        
        <div class="ticket-number" id="ticketNumber">Wird geladen...</div>
        
        <div class="ticket-details">
            <div class="detail-item">
                <span class="detail-label">
                    <svg width="12" height="12" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18ZM11 6C11 5.44772 10.5523 5 10 5C9.44772 5 9 5.44772 9 6V10C9 10.2652 9.10536 10.5196 9.29289 10.7071L12.1213 13.5355C12.5118 13.9261 13.145 13.9261 13.5355 13.5355C13.9261 13.145 13.9261 12.5118 13.5355 12.1213L11 9.58579V6Z"/>
                    </svg>
                    Gültig von:
                </span>
                <span class="detail-value" id="validFrom">Wird geladen...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    Gültig bis:
                </span>
                <span class="detail-value" id="validUntil">Wird geladen...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    Ausgestellt:
                </span>
                <span class="detail-value" id="issuedAt">Wird geladen...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    Geltungsbereich:
                </span>
                <span class="detail-value" id="region">Wird geladen...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    Klasse:
                </span>
                <span class="detail-value" id="class">Wird geladen...</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">
                    <svg width="12" height="12" viewBox="0 0 20 20">
                        <path d="M14 5.5C14 7.36384 12.7252 8.92994 11 9.37398V13C11 13.5523 10.5523 14 10 14C9.44771 14 9 13.5523 9 13V9.37398C7.27477 8.92994 6 7.36384 6 5.5C6 3.29086 7.79086 1.5 10 1.5C12.2091 1.5 14 3.29086 14 5.5Z"/>
                        <path d="M1.5 14.5C1.5 12.7003 4.02566 11.1782 7.5 10.6758V13C7.5 14.3807 8.61929 15.5 10 15.5C11.3807 15.5 12.5 14.3807 12.5 13V10.6758C15.9743 11.1782 18.5 12.7003 18.5 14.5C18.5 16.7091 14.6944 18.5 10 18.5C5.30558 18.5 1.5 16.7091 1.5 14.5Z"/>
                    </svg>
                    Preisstufe:
                </span>
                <span class="detail-value" id="priceLevel">Wird geladen...</span>
            </div>
        </div>
        
        <div class="footer">
            <a href="https://www.mvbnet.de/fahrkarten/deutschlandticket/" target="_blank" rel="noopener noreferrer">MVB – Deutschland-Ticket</a>
        </div>
        
        <div class="liveness-indicator"></div>
    </div>

    <script>
        // DOM элементы
        const updateBtn = document.getElementById('updateBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusIcon = document.getElementById('statusIcon');
        const lastUpdatedTime = document.getElementById('lastUpdatedTime');
        const qrImage = document.getElementById('qrImage');
        
        // Элементы данных билета
        const ticketNumberEl = document.getElementById('ticketNumber');
        const validFromEl = document.getElementById('validFrom');
        const validUntilEl = document.getElementById('validUntil');
        const issuedAtEl = document.getElementById('issuedAt');
        const regionEl = document.getElementById('region');
        const classEl = document.getElementById('class');
        const priceLevelEl = document.getElementById('priceLevel');
        
        // Состояние загрузки
        let isLoading = false;
        
        // Обновление статуса
        function updateStatus(message, isError = false, showSpinner = false) {
            statusIndicator.textContent = message;
            statusIcon.innerHTML = '';
            
            if (showSpinner) {
                statusIcon.innerHTML = '<div class="spinner"></div>';
            } else if (!isError) {
                // Показать зеленую галочку при успешном обновлении
                statusIcon.innerHTML = '<span style="color:#2e7d32">✓</span>';
            } else {
                // Показать красный крест при ошибке
                statusIcon.innerHTML = '<span style="color:#c62828">✗</span>';
            }
        }
        
        // Обновление данных билета с сервера
        async function fetchTicketData() {
            if (isLoading) return;
            
            isLoading = true;
            updateBtn.disabled = true;
            updateStatus('Aktualisiere Ticket...', false, true);
            
            try {
                // Имитация задержки для демонстрации индикатора загрузки
                await new Promise(resolve => setTimeout(resolve, 800));
                
                // Здесь должна быть реализована логика обновления данных
                // В настоящем приложении здесь будет AJAX-запрос к серверу
                console.log('Обновление данных билета...');
                
                // Имитация успешного ответа
                const response = await fetch('/ticket_data.json?' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('Не удалось загрузить данные билета');
                }
                
                const ticketData = await response.json();
                
                // Обновление элементов страницы
                ticketNumberEl.textContent = ticketData.ticket_number;
                validFromEl.textContent = ticketData.valid_from;
                validUntilEl.textContent = ticketData.valid_until;
                regionEl.textContent = ticketData.region;
                classEl.textContent = ticketData.class;
                priceLevelEl.textContent = ticketData.price_level || 'deutschlandweit';
                
                // Вычисление времени выдачи (примерно за 3 минуты до текущего времени)
                const now = new Date();
                now.setMinutes(now.getMinutes() - 3);
                issuedAtEl.textContent = now.toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }).replace(',', '') + ' Uhr';
                
                // Обновление QR-кода с уникальным параметром для обхода кэша
                const timestamp = new Date().getTime();
                qrImage.src = `qr-code.png?t=${timestamp}`;
                
                // Обновление времени последней загрузки
                lastUpdatedTime.textContent = ticketData.last_updated;
                
                // Обновление статуса
                updateStatus('Ticket erfolgreich aktualisiert!', false, false);
                console.log('Данные билета успешно обновлены');
                
            } catch (error) {
                console.error('Ошибка при обновлении билета:', error);
                updateStatus(`Fehler: ${error.message}`, true, false);
            } finally {
                isLoading = false;
                updateBtn.disabled = false;
                
                // Скрыть индикатор через 3 секунды
                setTimeout(() => {
                    if (statusIcon.innerHTML.includes('✓') || statusIcon.innerHTML.includes('✗')) {
                        statusIcon.innerHTML = '';
                    }
                }, 3000);
            }
        }
        
        // Автоматическое обновление каждые 5 минут
        function setupAutoRefresh() {
            setInterval(fetchTicketData, 5 * 60 * 1000);
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            // Загрузка данных билета
            await fetchTicketData();
            
            // Настройка автоматического обновления
            setupAutoRefresh();
            
            // Обработчик кнопки обновления
            updateBtn.addEventListener('click', fetchTicketData);
        });
        
        // Обработка ошибок загрузки изображения QR-кода
        qrImage.onerror = function() {
            console.error('Ошибка загрузки QR-кода');
            this.src = 'static/placeholder_qr.png';
        };
    </script>
</body>
</html>
